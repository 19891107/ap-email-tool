<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>AP Payment Email Generator</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:"Segoe UI",sans-serif;background:#f0f4f8;min-height:100vh}
  input,textarea{font-family:"Segoe UI",sans-serif}
  kbd{background:#eee;padding:1px 5px;border-radius:3px;font-size:12px}
  a{color:#1F3864}
  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš™ï¸  CONFIGURATION â€” å¡«å…¥ä½ çš„ Azure App Client ID
//      æ³¨å†Œåœ°å€: https://portal.azure.com â†’ App registrations
//      Redirect URI: æœ¬æ–‡ä»¶åœ¨ SharePoint ä¸Šçš„å®Œæ•´ URL
//      Permission: Mail.ReadWrite (Delegated)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLIENT_ID    = "5469cd12-9e8c-4344-8120-3c3f7b8bcdfe"; // <-- æ›¿æ¢è¿™é‡Œ
const TENANT_ID    = "d01ba920-936c-43d4-9122-56a0a8295ec7";           // <-- æ›¿æ¢è¿™é‡Œ
const REDIRECT_URI = window.location.href.split("?")[0].split("#")[0];
const SCOPES       = "openid profile Mail.ReadWrite";
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SAMPLE_DATA = [
  {vendor:"EuroFast",  invoice:"EFI2312",     amount:"26,396.00",  currency:"RON",comment:""},
  {vendor:"RootsEOR",  invoice:"807",          amount:"20,314.30",  currency:"USD",comment:""},
  {vendor:"People2.0", invoice:"CISE01004298", amount:"41,801.12",  currency:"SEK",comment:""},
  {vendor:"People2.0", invoice:"CISE01004295", amount:"488,092.20", currency:"SEK",comment:""},
  {vendor:"People2.0", invoice:"CISE01004297", amount:"101,120.72", currency:"SEK",comment:""},
  {vendor:"People2.0", invoice:"CISE01004296", amount:"147,277.39", currency:"SEK",comment:""},
];

const CONTACTS_KEY = "ap_contacts_v4";
const SETTINGS_KEY = "ap_settings_v4";
function loadLS(k,d){try{const s=localStorage.getItem(k);return s?JSON.parse(s):d;}catch{return d;}}
function saveLS(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch{}}

function groupByVendor(rows){
  return rows.reduce((a,r)=>{(a[r.vendor]=a[r.vendor]||[]).push(r);return a;},{});
}
function parseCSV(text){
  const lines=text.trim().split("\n").filter(l=>l.trim());
  if(lines.length<2)return[];
  const headers=lines[0].split("\t").map(h=>h.trim().toLowerCase().replace(/\r/g,""));
  return lines.slice(1).map(line=>{
    const cols=line.split("\t");
    const r={};
    headers.forEach((h,i)=>{r[h]=(cols[i]||"").trim().replace(/\r/g,"");});
    return{
      vendor:  r["vendor"]||r["vendor name"]||"",
      invoice: r["invoice no."]||r["invoice no"]||r["invoice"]||"",
      amount:  r["amount local"]||r["amount"]||"",
      currency:r["currency"]||"",
      comment: r["comment/track link"]||r["comment"]||"",
    };
  }).filter(r=>r.vendor);
}

// â”€â”€ PKCE OAuth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function b64url(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");}
async function generatePKCE(){
  const verifier=b64url(crypto.getRandomValues(new Uint8Array(32)));
  const digest=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(verifier));
  return{verifier,challenge:b64url(digest)};
}
function buildAuthURL(challenge,state){
  const p=new URLSearchParams({client_id:CLIENT_ID,response_type:"code",redirect_uri:REDIRECT_URI,
    scope:SCOPES,code_challenge:challenge,code_challenge_method:"S256",response_mode:"fragment",state});
  return`https://login.microsoftonline.com/${TENANT_ID}/oauth2/v2.0/authorize?${p}`;
}
async function exchangeCode(code,verifier){
  const r=await fetch(`https://login.microsoftonline.com/${TENANT_ID}/oauth2/v2.0/token`,{
    method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:new URLSearchParams({client_id:CLIENT_ID,grant_type:"authorization_code",
      code,redirect_uri:REDIRECT_URI,code_verifier:verifier}),
  });
  return r.json();
}

// â”€â”€ Email HTML builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildHTML(vendor,invoices,groups,hasFiles,senderName,senderCompany,date){
  const font="font-family:Arial,sans-serif;font-size:11pt;color:#222;";
  const p=`style="${font}margin:0 0 14pt 0;"`;
  const th=`style="background:#1F3864;color:#ffffff;padding:8px 12px;text-align:left;border:1px solid #1F3864;font-family:Arial,sans-serif;font-size:11pt;"`;
  const td=bg=>`style="padding:7px 12px;border:1px solid #d0d0d0;font-family:Arial,sans-serif;font-size:11pt;background:${bg};"`;
  const tdR=bg=>`style="padding:7px 12px;border:1px solid #d0d0d0;font-family:Arial,sans-serif;font-size:11pt;text-align:right;background:${bg};"`;
  let rows="";
  groups.forEach((g,gi)=>{
    const bg=gi%2===0?"#ffffff":"#f0f4fa";
    const gInv=(g.invoiceIndices||[]).map(i=>invoices[i]).filter(Boolean);
    gInv.forEach((inv,ii)=>{
      const trace=ii===0
        ?`<td ${td(bg)} rowspan="${gInv.length}">${g.traceLink?`<a href="${g.traceLink}" style="color:#1F3864;">View Trace</a>`:"â€”"}</td>`
        :"";
      rows+=`<tr><td ${td(bg)}>${inv.invoice}</td><td ${td(bg)}>${inv.currency}</td><td ${tdR(bg)}>${inv.amount}</td><td ${td(bg)}>${inv.comment||"â€”"}</td>${trace}</tr>\n`;
    });
  });
  return`<div style="${font}line-height:1.6;max-width:700px;">
<p ${p}>Dear ${vendor} Team,</p>
<p ${p}>We are pleased to inform you that the following payment(s) have been successfully processed on <strong>${date}</strong>. Please find the details below:</p>
<table style="border-collapse:collapse;width:100%;"><thead><tr>
  <th ${th}>Invoice No.</th><th ${th}>Currency</th><th ${th}>Amount</th><th ${th}>Notes</th><th ${th}>Payment Trace</th>
</tr></thead><tbody>${rows}</tbody></table>
<p style="margin:0 0 14pt 0;"> </p>
${hasFiles?`<p ${p}>Please find the remittance advice attached to this email for your reference.</p>`:""}
<p ${p}>Could you please confirm receipt of the above payment(s)? Should you have any questions or notice any discrepancies, please do not hesitate to contact us.</p>
<p ${p}>Best regards,<br/><strong>${senderName}</strong><br/>${senderCompany}</p>
</div>`;
}

// â”€â”€ TagInput â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TagInput({value=[],onChange,placeholder}){
  const[input,setInput]=useState("");
  const add=v=>{const items=v.split(/[,;\s]+/).map(e=>e.trim()).filter(Boolean);onChange([...new Set([...value,...items])]);setInput("");};
  const onKey=e=>{
    if(["Enter",",",";","Tab"].includes(e.key)){e.preventDefault();if(input.trim())add(input);}
    else if(e.key==="Backspace"&&!input&&value.length)onChange(value.slice(0,-1));
  };
  return(
    <div onClick={e=>e.currentTarget.querySelector("input").focus()}
      style={{display:"flex",flexWrap:"wrap",gap:4,border:"1px solid #ddd",borderRadius:6,padding:"5px 8px",background:"#fff",minHeight:36,cursor:"text"}}>
      {value.map((t,i)=>(
        <span key={i} style={{background:"#e8edf8",color:"#1F3864",borderRadius:4,padding:"2px 8px",fontSize:12,display:"flex",alignItems:"center",gap:4}}>
          {t}<span onClick={()=>onChange(value.filter((_,j)=>j!==i))} style={{cursor:"pointer",fontWeight:700,opacity:0.6}}>Ã—</span>
        </span>
      ))}
      <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={onKey}
        onBlur={()=>{if(input.trim())add(input);}}
        placeholder={value.length===0?placeholder:""}
        style={{border:"none",outline:"none",fontSize:13,flex:1,minWidth:100,padding:"2px 0"}}/>
    </div>
  );
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const[rows,setRows]           =useState(SAMPLE_DATA);
  const[contacts,setContacts]   =useState(()=>loadLS(CONTACTS_KEY,{}));
  const[settings,setSettings]   =useState(()=>loadLS(SETTINGS_KEY,{senderName:"AP Team",senderCompany:"Your Company"}));
  const[paymentDate,setDate]    =useState(()=>new Date().toISOString().split("T")[0]);
  const[attachments,setAtt]     =useState({});
  const[drafts,setDrafts]       =useState({});
  const[activeTab,setTab]       =useState("data");
  const[activeDraft,setAD]      =useState(null);
  const[editingBody,setEB]      =useState({});
  const[pasteText,setPaste]     =useState("");
  const[token,setToken]         =useState(null);
  const[userEmail,setUserEmail] =useState(null);
  const[authStatus,setAS]       =useState("idle");
  const[pushStatus,setPS]       =useState({});
  const[pushAll,setPushAll]     =useState("idle");

  const grouped=groupByVendor(rows);
  const vendors=Object.keys(grouped);

  useEffect(()=>{saveLS(CONTACTS_KEY,contacts);},[contacts]);
  useEffect(()=>{saveLS(SETTINGS_KEY,settings);},[settings]);

  useEffect(()=>{
    setContacts(c=>{const n={...c};vendors.forEach(v=>{if(!n[v])n[v]={to:[],cc:[]};});return n;});
    setAtt(a=>{
      const n={...a};
      vendors.forEach(v=>{
        if(!n[v])n[v]={groups:[{invoiceIndices:grouped[v].map((_,i)=>i),traceLink:"",note:""}],files:[]};
      });
      return n;
    });
  },[rows]);

  // Handle OAuth redirect
  useEffect(()=>{
    const hash=window.location.hash;
    if(!hash.includes("code="))return;
    const params=new URLSearchParams(hash.replace("#",""));
    const code=params.get("code");
    const verifier=sessionStorage.getItem("pkce_verifier");
    if(!code||!verifier)return;
    setAS("pending");
    exchangeCode(code,verifier).then(async data=>{
      if(data.access_token){
        setToken(data.access_token);
        setAS("done");
        const me=await fetch("https://graph.microsoft.com/v1.0/me",{headers:{Authorization:`Bearer ${data.access_token}`}}).then(r=>r.json());
        setUserEmail(me.userPrincipalName||me.mail||"");
        window.history.replaceState(null,"",window.location.pathname);
      }else{setAS("error");}
    }).catch(()=>setAS("error"));
  },[]);

  const handleLogin=async()=>{
    const{verifier,challenge}=await generatePKCE();
    sessionStorage.setItem("pkce_verifier",verifier);
    window.location.href=buildAuthURL(challenge,Math.random().toString(36).slice(2));
  };

  const getGroups=v=>attachments[v]?.groups||[{invoiceIndices:(grouped[v]||[]).map((_,i)=>i),traceLink:"",note:""}];
  const setGroups=(v,gs)=>setAtt(a=>({...a,[v]:{...a[v],groups:gs}}));
  const updateGroup=(v,gi,f,val)=>{const gs=[...getGroups(v)];gs[gi]={...gs[gi],[f]:val};setGroups(v,gs);};
  const toggleInvoice=(v,gi,idx)=>{
    const gs=getGroups(v).map((g,i)=>{
      if(i===gi){const has=g.invoiceIndices.includes(idx);return{...g,invoiceIndices:has?g.invoiceIndices.filter(x=>x!==idx):[...g.invoiceIndices,idx]};}
      return{...g,invoiceIndices:g.invoiceIndices.filter(x=>x!==idx)};
    });
    setGroups(v,gs);
  };
  const addGroup=v=>{
    const gs=getGroups(v);const used=gs.flatMap(g=>g.invoiceIndices);
    const free=(grouped[v]||[]).map((_,i)=>i).filter(i=>!used.includes(i));
    setGroups(v,[...gs,{invoiceIndices:free,traceLink:"",note:""}]);
  };
  const removeGroup=(v,gi)=>{
    const gs=getGroups(v).filter((_,i)=>i!==gi);
    setGroups(v,gs.length?gs:[{invoiceIndices:(grouped[v]||[]).map((_,i)=>i),traceLink:"",note:""}]);
  };
  const handleFile=(v,files)=>Array.from(files).forEach(f=>{
    const r=new FileReader();r.onload=e=>setAtt(a=>({...a,[v]:{...a[v],files:[...(a[v]?.files||[]),{name:f.name,dataUrl:e.target.result}]}}));r.readAsDataURL(f);
  });
  const removeFile=(v,i)=>setAtt(a=>({...a,[v]:{...a[v],files:a[v].files.filter((_,j)=>j!==i)}}));

  const buildDrafts=()=>{
    const nd={};
    vendors.forEach(v=>{
      const invoices=grouped[v],groups=getGroups(v),hasFiles=(attachments[v]?.files||[]).length>0;
      nd[v]={to:contacts[v]?.to||[],cc:contacts[v]?.cc||[],
        subject:`Payment Notification â€“ ${v} â€“ ${paymentDate}`,
        body:buildHTML(v,invoices,groups,hasFiles,settings.senderName,settings.senderCompany,paymentDate),
        invoices,files:attachments[v]?.files||[]};
    });
    setDrafts(nd);setAD(vendors[0]);setTab("drafts");
  };

  const pushToOutlook=async v=>{
    if(!token)return;
    const d=drafts[v];
    setPS(s=>({...s,[v]:"pushing"}));
    try{
      const res=await fetch("https://graph.microsoft.com/v1.0/me/messages",{
        method:"POST",
        headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
        body:JSON.stringify({
          subject:d.subject,importance:"Normal",
          body:{contentType:"HTML",content:d.body},
          toRecipients:d.to.map(a=>({emailAddress:{address:a}})),
          ...(d.cc?.length?{ccRecipients:d.cc.map(a=>({emailAddress:{address:a}}))}:{}),
        }),
      });
      setPS(s=>({...s,[v]:res.ok?"done":"error"}));
    }catch{setPS(s=>({...s,[v]:"error"}));}
  };

  const pushAllToOutlook=async()=>{
    setPushAll("pushing");
    for(const v of Object.keys(drafts))await pushToOutlook(v);
    setPushAll("done");setTimeout(()=>setPushAll("idle"),3000);
  };

  const updateDraft=(v,f,val)=>setDrafts(d=>({...d,[v]:{...d[v],[f]:val}}));

  const IS={width:"100%",padding:"8px 10px",borderRadius:6,border:"1px solid #ddd",fontSize:13,boxSizing:"border-box"};
  const card=(x={})=>({background:"#fff",borderRadius:10,padding:20,boxShadow:"0 1px 4px rgba(0,0,0,0.08)",marginBottom:16,...x});
  const tabBtn=t=>({padding:"11px 16px",border:"none",background:"none",cursor:"pointer",fontSize:13,
    fontWeight:activeTab===t?700:400,borderBottom:activeTab===t?"3px solid #1F3864":"3px solid transparent",
    color:activeTab===t?"#1F3864":"#555"});
  const btn=(x={})=>({border:"none",borderRadius:7,padding:"9px 18px",cursor:"pointer",fontSize:13,fontWeight:600,...x});

  const isConfigured=CLIENT_ID!=="YOUR_AZURE_APP_CLIENT_ID";

  return(
    <div style={{fontFamily:"Segoe UI,sans-serif",background:"#f0f4f8",minHeight:"100vh"}}>

      {/* Header */}
      <div style={{background:"linear-gradient(135deg,#1F3864,#2e5491)",color:"#fff",padding:"16px 28px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
        <div style={{display:"flex",alignItems:"center",gap:12}}>
          <span style={{fontSize:26}}>ğŸ“§</span>
          <div>
            <div style={{fontWeight:700,fontSize:17}}>AP Payment Email Generator</div>
            <div style={{fontSize:11,opacity:0.85}}>Outlook Draft Integration Â· Flexible grouping Â· Trace links</div>
          </div>
        </div>
        <div>
          {!isConfigured?(
            <div style={{background:"#ff9800",color:"#fff",borderRadius:8,padding:"7px 14px",fontSize:12,fontWeight:600}}>âš ï¸ Azure App ID not configured</div>
          ):authStatus==="done"?(
            <div style={{background:"rgba(255,255,255,0.15)",borderRadius:8,padding:"7px 14px",fontSize:12,display:"flex",alignItems:"center",gap:6}}>
              <span style={{color:"#90ee90",fontWeight:700}}>âœ“ Connected</span>
              <span style={{opacity:0.8}}>{userEmail}</span>
            </div>
          ):(
            <button onClick={handleLogin} style={btn({background:"#fff",color:"#1F3864",boxShadow:"0 2px 6px rgba(0,0,0,0.2)"})}>
              ğŸ”‘ Sign in with Microsoft
            </button>
          )}
        </div>
      </div>

      {/* Setup banner */}
      {!isConfigured&&(
        <div style={{background:"#fff3cd",borderBottom:"1px solid #ffc107",padding:"10px 28px",fontSize:13,color:"#7a5000"}}>
          <strong>Setup required:</strong> å°†ä»£ç é¡¶éƒ¨çš„ <code>YOUR_AZURE_APP_CLIENT_ID</code> æ›¿æ¢ä¸ºä½ çš„ Azure App Client IDã€‚
          {" "}<a href="https://portal.azure.com/#view/Microsoft_AAD_RegisteredApps/ApplicationsListBlade" target="_blank" rel="noreferrer">Azure Portal æ³¨å†Œ â†’</a>
          {" "}(Redirect URI = æœ¬æ–‡ä»¶çš„ SharePoint URLï¼Œæƒé™é€‰ <strong>Mail.ReadWrite</strong> Delegated)
        </div>
      )}

      {/* Tabs */}
      <div style={{background:"#fff",borderBottom:"2px solid #e2e8f0",display:"flex",padding:"0 24px",overflowX:"auto"}}>
        {[["data","ğŸ“Š Data"],["contacts","ğŸ‘¥ Contacts"],["attachments","ğŸ“ Links & Files"],["settings","âš™ï¸ Settings"],
          ["drafts",`âœ‰ï¸ Drafts${Object.keys(drafts).length?` (${Object.keys(drafts).length})`:""}`]
        ].map(([t,label])=><button key={t} style={tabBtn(t)} onClick={()=>setTab(t)}>{label}</button>)}
      </div>

      <div style={{padding:20,maxWidth:1100,margin:"0 auto"}}>

        {/* DATA */}
        {activeTab==="data"&&<>
          <div style={card()}>
            <div style={{fontWeight:600,marginBottom:6}}>ğŸ“‹ Paste from Excel</div>
            <div style={{fontSize:12,color:"#666",marginBottom:8}}>é€‰ä¸­ä»˜æ¬¾è¡¨ï¼ˆå«è¡¨å¤´ï¼‰â†’ Ctrl+C â†’ ç²˜è´´ â†’ Load</div>
            <textarea value={pasteText} onChange={e=>setPaste(e.target.value)} placeholder="Paste Excel data here..."
              style={{width:"100%",height:80,borderRadius:6,border:"1px solid #ddd",padding:10,fontSize:13,resize:"vertical",boxSizing:"border-box"}}/>
            <button onClick={()=>{const p=parseCSV(pasteText);if(p.length){setRows(p);alert(`âœ… ${p.length} rows loaded`);}else alert("âŒ Parse failed");}}
              style={btn({marginTop:8,background:"#1F3864",color:"#fff"})}>Load Data</button>
          </div>
          <div style={card()}>
            <div style={{fontWeight:600,marginBottom:10}}>Current Data â€” {rows.length} rows Â· {vendors.length} vendors</div>
            <div style={{overflowX:"auto"}}>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:13}}>
                <thead><tr style={{background:"#f7f9fc"}}>
                  {["Vendor","Invoice No.","Amount","Currency","Comment"].map(h=>(
                    <th key={h} style={{padding:"7px 10px",textAlign:"left",borderBottom:"2px solid #e2e8f0",color:"#555"}}>{h}</th>
                  ))}
                </tr></thead>
                <tbody>{rows.map((r,i)=>(
                  <tr key={i} style={{borderBottom:"1px solid #f0f0f0",background:i%2?"#fafafa":"#fff"}}>
                    <td style={{padding:"6px 10px",fontWeight:600}}>{r.vendor}</td>
                    <td style={{padding:"6px 10px",fontFamily:"monospace"}}>{r.invoice}</td>
                    <td style={{padding:"6px 10px",textAlign:"right"}}>{r.amount}</td>
                    <td style={{padding:"6px 10px"}}><span style={{background:"#e8edf8",color:"#1F3864",padding:"2px 7px",borderRadius:4,fontSize:11,fontWeight:600}}>{r.currency}</span></td>
                    <td style={{padding:"6px 10px",color:"#888",fontSize:12}}>{r.comment||"â€”"}</td>
                  </tr>
                ))}</tbody>
              </table>
            </div>
          </div>
        </>}

        {/* CONTACTS */}
        {activeTab==="contacts"&&<>
          <div style={card({background:"#fffbea",border:"1px solid #f0e68c",padding:"12px 16px"})}>
            <span style={{fontSize:13,color:"#7a6200"}}>ğŸ’¾ è”ç³»äººè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ã€‚è¾“å…¥åæŒ‰ <kbd>Enter</kbd> æˆ– <kbd>,</kbd> ç¡®è®¤ï¼Œæ”¯æŒå¤šä¸ªã€‚</span>
          </div>
          {vendors.map(v=>(
            <div key={v} style={card()}>
              <div style={{fontWeight:700,color:"#1F3864",marginBottom:12,fontSize:14}}>ğŸ¢ {v}</div>
              <div style={{display:"grid",gap:10}}>
                <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>TO</label>
                  <TagInput value={contacts[v]?.to||[]} onChange={val=>setContacts(c=>({...c,[v]:{...c[v],to:val}}))} placeholder="to@vendor.com"/></div>
                <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>CC</label>
                  <TagInput value={contacts[v]?.cc||[]} onChange={val=>setContacts(c=>({...c,[v]:{...c[v],cc:val}}))} placeholder="cc@company.com"/></div>
              </div>
            </div>
          ))}
        </>}

        {/* LINKS & FILES */}
        {activeTab==="attachments"&&<>
          <div style={card({background:"#f0f4ff",border:"1px solid #c7d2fe",padding:"12px 16px"})}>
            <div style={{fontSize:13,color:"#3730a3"}}>ğŸ”— <strong>Payment Grouping</strong>ï¼šå¤šå¼ invoiceåˆå¹¶ä¸€ç¬”å…±ç”¨ä¸€ä¸ªtrace linkï¼Œæˆ–åˆ†å¼€å¤šç¬”å„è‡ªå¯¹åº”ã€‚</div>
          </div>
          {vendors.map(v=>{
            const invoices=grouped[v],groups=getGroups(v);
            const allAssigned=invoices.map((_,i)=>groups.some(g=>g.invoiceIndices.includes(i)));
            return(
              <div key={v} style={card()}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
                  <div style={{fontWeight:700,color:"#1F3864",fontSize:14}}>ğŸ¢ {v} <span style={{fontWeight:400,fontSize:12,color:"#888"}}>({invoices.length} invoices)</span></div>
                  <button onClick={()=>addGroup(v)} style={btn({background:"#e8edf8",color:"#1F3864",border:"1px solid #b0c0e0",padding:"5px 12px",fontSize:12})}>+ Add Payment Group</button>
                </div>
                {groups.map((g,gi)=>(
                  <div key={gi} style={{border:"1px solid #e2e8f0",borderRadius:8,padding:14,marginBottom:10,background:"#fafcff"}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                      <span style={{fontWeight:600,fontSize:13,color:"#444"}}>Group {gi+1} <span style={{fontWeight:400,color:"#888"}}>({g.invoiceIndices.length} invoice{g.invoiceIndices.length!==1?"s":""})</span></span>
                      {groups.length>1&&<button onClick={()=>removeGroup(v,gi)} style={{background:"none",border:"none",color:"#ef4444",cursor:"pointer",fontSize:18,lineHeight:1}}>Ã—</button>}
                    </div>
                    <div style={{marginBottom:10}}>
                      <div style={{fontSize:12,color:"#777",marginBottom:6}}>Invoices in this group:</div>
                      <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                        {invoices.map((inv,idx)=>{
                          const inThis=g.invoiceIndices.includes(idx);
                          const inOther=!inThis&&groups.some((og,ogi)=>ogi!==gi&&og.invoiceIndices.includes(idx));
                          return(
                            <button key={idx} onClick={()=>toggleInvoice(v,gi,idx)}
                              style={{padding:"4px 10px",borderRadius:6,fontSize:12,cursor:"pointer",fontWeight:inThis?700:400,
                                background:inThis?"#1F3864":inOther?"#f3f4f6":"#fff",
                                color:inThis?"#fff":inOther?"#aaa":"#444",
                                border:inThis?"1px solid #1F3864":"1px solid #ccc",
                                textDecoration:inOther?"line-through":"none"}}>
                              {inv.invoice} <span style={{opacity:0.7}}>{inv.currency} {inv.amount}</span>
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
                      <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>ğŸ”— Trace Link</label>
                        <input value={g.traceLink} onChange={e=>updateGroup(v,gi,"traceLink",e.target.value)} placeholder="https://bank.com/trace/..." style={IS}/></div>
                      <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>ğŸ“ Note</label>
                        <input value={g.note} onChange={e=>updateGroup(v,gi,"note",e.target.value)} placeholder="e.g. Wire batch 1" style={IS}/></div>
                    </div>
                  </div>
                ))}
                {allAssigned.some(a=>!a)&&(
                  <div style={{fontSize:12,color:"#b45309",background:"#fff7ed",borderRadius:6,padding:"6px 10px"}}>
                    âš ï¸ Unassigned: {invoices.filter((_,i)=>!allAssigned[i]).map(r=>r.invoice).join(", ")}
                  </div>
                )}
                <div style={{marginTop:14,paddingTop:12,borderTop:"1px dashed #e2e8f0"}}>
                  <label style={{fontSize:12,color:"#777",display:"block",marginBottom:6}}>ğŸ“„ Remittance Attachment</label>
                  <label style={{background:"#f0f4f8",border:"2px dashed #ccc",borderRadius:8,padding:"8px 16px",cursor:"pointer",fontSize:13,color:"#555",display:"inline-block"}}>
                    + Upload PDF / Image
                    <input type="file" accept=".pdf,image/*" multiple style={{display:"none"}} onChange={e=>handleFile(v,e.target.files)}/>
                  </label>
                  {(attachments[v]?.files||[]).length>0&&(
                    <div style={{marginTop:8,display:"flex",flexWrap:"wrap",gap:6}}>
                      {attachments[v].files.map((f,i)=>(
                        <span key={i} style={{background:"#fff7ed",border:"1px solid #fed7aa",borderRadius:6,padding:"4px 10px",fontSize:12,display:"flex",alignItems:"center",gap:6}}>
                          ğŸ“„ {f.name}<span onClick={()=>removeFile(v,i)} style={{cursor:"pointer",color:"#ef4444",fontWeight:700}}>Ã—</span>
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </>}

        {/* SETTINGS */}
        {activeTab==="settings"&&(
          <div style={card()}>
            <div style={{fontWeight:600,marginBottom:14}}>Email Settings</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:14}}>
              <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:4}}>Payment Date</label>
                <input type="date" value={paymentDate} onChange={e=>setDate(e.target.value)} style={IS}/></div>
              <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:4}}>Sender Name</label>
                <input value={settings.senderName} onChange={e=>setSettings(s=>({...s,senderName:e.target.value}))} style={IS}/></div>
              <div style={{gridColumn:"span 2"}}><label style={{fontSize:12,color:"#777",display:"block",marginBottom:4}}>Company Name</label>
                <input value={settings.senderCompany} onChange={e=>setSettings(s=>({...s,senderCompany:e.target.value}))} style={IS}/></div>
            </div>
          </div>
        )}

        {/* DRAFTS */}
        {activeTab==="drafts"&&(
          Object.keys(drafts).length===0
            ?<div style={{...card(),textAlign:"center",padding:40}}><div style={{fontSize:44,marginBottom:10}}>âœ‰ï¸</div><div style={{color:"#555"}}>No drafts yet â€” click Generate below</div></div>
            :<div>
              <div style={card({
                background:authStatus==="done"?"#f0f4ff":"#fff8e1",
                border:`1px solid ${authStatus==="done"?"#c7d2fe":"#ffe082"}`,
                padding:"12px 16px",display:"flex",alignItems:"center",justifyContent:"space-between",gap:12
              })}>
                {authStatus==="done"
                  ?<div style={{fontSize:13,color:"#3730a3"}}>âœ… Connected as <strong>{userEmail}</strong> â€” ready to push drafts to Outlook</div>
                  :<div style={{fontSize:13,color:"#7a5000"}}>âš ï¸ Sign in with Microsoft (top right) to push drafts directly to Outlook</div>}
                {authStatus==="done"&&(
                  <button onClick={pushAllToOutlook} disabled={pushAll==="pushing"}
                    style={btn({background:pushAll==="done"?"#22c55e":pushAll==="pushing"?"#aaa":"#1F3864",color:"#fff",whiteSpace:"nowrap",minWidth:220})}>
                    {pushAll==="pushing"?"â³ Pushing all...":pushAll==="done"?"âœ… All drafts saved!":`ğŸ“¥ Save All ${Object.keys(drafts).length} Drafts to Outlook`}
                  </button>
                )}
              </div>
              <div style={{display:"grid",gridTemplateColumns:"210px 1fr",gap:16}}>
                <div>
                  {Object.keys(drafts).map(v=>(
                    <div key={v} onClick={()=>setAD(v)} style={{padding:"10px 14px",borderRadius:8,marginBottom:6,cursor:"pointer",
                      background:activeDraft===v?"#e8edf8":"#fff",
                      border:activeDraft===v?"2px solid #1F3864":"2px solid transparent",
                      boxShadow:"0 1px 3px rgba(0,0,0,0.07)"}}>
                      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                        <span style={{fontWeight:600,fontSize:13}}>{v}</span>
                        {pushStatus[v]==="done"&&<span>âœ…</span>}
                        {pushStatus[v]==="pushing"&&<span style={{fontSize:13,color:"#1F3864"}}>â³</span>}
                        {pushStatus[v]==="error"&&<span>âŒ</span>}
                      </div>
                      <div style={{fontSize:11,color:"#888",marginTop:2}}>
                        {drafts[v].invoices.length} inv Â· {drafts[v].to.length>0?`${drafts[v].to.length} TO`:"âš ï¸ no TO"}
                      </div>
                    </div>
                  ))}
                </div>
                {activeDraft&&drafts[activeDraft]&&(
                  <div style={card()}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
                      <div style={{fontWeight:700,fontSize:15,color:"#1F3864"}}>âœ‰ï¸ {activeDraft}</div>
                      {authStatus==="done"&&(
                        <button onClick={()=>pushToOutlook(activeDraft)} disabled={pushStatus[activeDraft]==="pushing"}
                          style={btn({background:pushStatus[activeDraft]==="done"?"#22c55e":pushStatus[activeDraft]==="pushing"?"#aaa":"#1F3864",color:"#fff"})}>
                          {pushStatus[activeDraft]==="pushing"?"â³ Saving...":pushStatus[activeDraft]==="done"?"âœ… Saved to Outlook!":pushStatus[activeDraft]==="error"?"âŒ Error â€” Retry":"ğŸ“¥ Save Draft to Outlook"}
                        </button>
                      )}
                    </div>
                    <div style={{display:"grid",gap:10,marginBottom:14}}>
                      <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>TO</label>
                        <TagInput value={drafts[activeDraft].to} onChange={v=>updateDraft(activeDraft,"to",v)} placeholder="recipient@vendor.com"/></div>
                      <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>CC</label>
                        <TagInput value={drafts[activeDraft].cc||[]} onChange={v=>updateDraft(activeDraft,"cc",v)} placeholder="cc@company.com"/></div>
                      <div><label style={{fontSize:12,color:"#777",display:"block",marginBottom:3}}>SUBJECT</label>
                        <input value={drafts[activeDraft].subject} onChange={e=>updateDraft(activeDraft,"subject",e.target.value)} style={IS}/></div>
                    </div>
                    {drafts[activeDraft].files?.length>0&&(
                      <div style={{marginBottom:12,padding:"8px 12px",background:"#fff7ed",borderRadius:8,fontSize:12,color:"#92400e"}}>
                        ğŸ“ Remember to manually attach in Outlook: {drafts[activeDraft].files.map(f=>f.name).join(", ")}
                      </div>
                    )}
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
                      <span style={{fontSize:12,color:"#777"}}>EMAIL PREVIEW</span>
                      <button onClick={()=>setEB(e=>({...e,[activeDraft]:!e[activeDraft]}))}
                        style={{fontSize:11,background:"none",border:"1px solid #ddd",borderRadius:4,padding:"2px 8px",cursor:"pointer",color:"#555"}}>
                        {editingBody[activeDraft]?"ğŸ‘ Preview":"âœï¸ Edit HTML"}
                      </button>
                    </div>
                    {editingBody[activeDraft]
                      ?<textarea value={drafts[activeDraft].body} onChange={e=>updateDraft(activeDraft,"body",e.target.value)}
                          style={{width:"100%",height:380,borderRadius:6,border:"1px solid #ddd",padding:10,fontSize:12,fontFamily:"monospace",resize:"vertical",boxSizing:"border-box"}}/>
                      :<div style={{border:"1px solid #e8e8e8",borderRadius:8,padding:20,background:"#fff",minHeight:280}}
                          dangerouslySetInnerHTML={{__html:drafts[activeDraft].body}}/>
                    }
                  </div>
                )}
              </div>
            </div>
        )}

        {activeTab!=="drafts"&&(
          <div style={{marginTop:16,textAlign:"center"}}>
            <button onClick={buildDrafts} disabled={rows.length===0}
              style={btn({background:"linear-gradient(135deg,#1F3864,#2e5491)",color:"#fff",padding:"13px 34px",fontSize:15,boxShadow:"0 4px 14px rgba(31,56,100,0.35)"})}>
              âœ¨ Generate {vendors.length} Draft Email{vendors.length!==1?"s":""}
            </button>
            <div style={{fontSize:11,color:"#999",marginTop:6}}>Arial 11pt Â· Navy header Â· Saves directly to Outlook Drafts folder</div>
          </div>
        )}

      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
